\chapter{SELECTするってどんなこと}

\section{SELECTの性質}

\subsection{フィルタとしてのSELECT}

リレーショナルデータベースへの問い合わせに使う、SELECTとななんなのでしょうか。それを理解するためには、SELECTとはどのような作用をしているかを理解する必要があります。

SELECTは、あるテーブルから条件にある要素を選び、その選んだ要素全てからなる集合を返します。この時、元のテーブルには、何の変化もありません。そして、取り出された要素がいくつあっても、その全てに合致する条件を一度書くだけで、取り出すことができます。このとき、手続き型言語であるようなループを書く必要はありません。

ループを使って、レコード一つ一つとマッチングするような命令を書かず、取り出すべき要素全てに該当する条件を書けばいいというのが、SELECTの特徴です。これは、フィルタの動作そのものです。

sedというテキストのフィルタを使ったことがあるなら、検索したい部分の条件を一度書いたら、対象の全てに対して適用され、結果が得られるというのを疑問に思わないでしょう。

では、テキストファイルがテーブルであり、テキストファイルの行がレコードであると考えてみたらどうでしょうか。テキストファイルというテーブルに対してSEKLECTを実行すれば、、検索条件に該当する、行というレコードが得られます。また、得られた結果の砲に、何らかの殻をすることもできます。ですがこのとき、元のテキストファイルの内容は、変化しません。変化しません。

実はこのような考え方で、テキストという集合から行という要素を取り出す言語が存在します。それは、awkです。awkは、テキスト全体に対してのフィルタとして作用します。そして、取り出した結果にかかわらず、元のテキストに影響を与えません。集合から要素を取り出して、結果とする、という考え方は、SQLとawkとで共通です。

\subsection{SELECTの結果}

SELECTを実行した結果は、元の集合から条件にある条件にある要素を取り出した集合です。この時の入力がテーブルであると考えたとき、出力は何になるのでしょうか。

SELECT文の出力は、かならずテーブルになります。現在の時間などをファンクションで取得したとしても、その結果を属性の値としてもつレコードひとつだけのテーブルとして返されます。

この結果のテーブルには、名前はありません。また、寿命もSELECTが実行されたときだけとなります。そのため、この結果を保存するためには、SELECTの結果をレコードとしてもつテーブルをCREATEするか、外部プロセスで、リレーショナルデータベースの外に取り出す課する必要があります。

\subsection{SELECTと関数}

ここで、テーブルという言葉を、集合にもどしてみましょう。このとき、SELECTは、ある集合から別の集合への、要素の対応関係を表している、とウッ言い方をすることができます。
つまり、SELECTの結果がテーブルであると言うことは、SELECTは集合間の写像関係を表しているということができます。

集合間の写像関係とは、数学で言うところの関数です。つまり、SELECT文とは、数学的な意味での関数であると考えることができます。

\subsection{SELECTと結果の加工}

SELECTでは、結果を加工することができます。例えば、以下のようなSELECT文を考えてみましょう。xaxisというテーブルのレコードは、zというアトリビュートを持ち、数値が入っているとします。

\begin{verbatim}
SELECT x+1 as y FROM xaxis;
\end{verbatim}

このSELECT文は、xaxisテーブルの全てのレコードを対象としています。xaxisテーブルのレコードがもつ、xというアトリビュートの値に1を足したアトリビュートyをもつレコードをつくり、そのレコードからなる名無しのテーブルをつくるという動作をします。
このように、SELECTは、元のテーブルに影響を与えず、加工されたレコードからなる結果のテーブルを作る、という動作します。


\subsection{SELECTと数学の関数}

先程のSELECT文は、$y=f(x)$ここで$f(x)=x+1$という、数学の関数と同じものです。もし、xaxisというテーブルのレコードで、全ての実数を網羅していれば、このSELECT文とその結果は、$y=x+1$という関数と全く同じものとなります。

ここで、関数を、集合と集合ｔの間の写像を行うルールである考えましょう。この例では、集合xaxisのxの値は、名無し集合で、xに1を足した$x+1$という値に対応している、というものです。こう考えれば、SELECTはまさに関数である、ということが理解しやすくなります。

SELECTとはなにかを一言で表すとしたら、それは数学でいう関数です。

たとえば、$y=x~2+1$という関数を考えてみます。この式は2次関数で、2次元直交座標系では、このようにあらわされます。
SELECｔが関数であれば、これをそのまま表現することができるはずです。

ここで、xaxisというテーブルを考えます。このテーブルは、直交座標系でx軸の上にある数値をとります。その名の通り、xaxisに含まれるレコードは、数値で、属性名がxであるとします。

テーブルxaxisのすべてのレコードは、重複なく、x軸上の数値を表します。つまり、属性xはxaxisのプライマリキーです。このような条件の下、ｘの値に対応したyの値のすべては、以下のSELECT文で求めることができます。

関数には、値域の範囲を指定して、その反意語と錦が変わる、というものがあります礼として、以下のような関数をSELECTで書いてみましょう。ここでは、関数の定期通りに書区子とを優先して、SELECT文としての効率は無視しています。

この関数は、このようなグラフとして著わすことができます。


\begin{verbatim}

SELECT s ,
CASE
  WHEN ｘ > 0 THEN x
  WHEN x = 0 THEN 1
  ELSE -x
as y
FROM xaxis;
\end{verbatim}

結果のレコードに属性としてxを追加しているのは、全てのアトリビュートが完全に一致するレコードができてしまうので、それを防ぐためです。

\subsection{なぜサブクエリを使えるのか}

SQLでは、テーブルの名前を書くべきとろこに、SELECT文を書く、サブクエリを使うことができます。本来は、テーブル名を書くところで、SELECT文を書くことができるという機能です。この機能の根拠は何なのでしょうか。

サブクエリでは、そのSELECT文の結果がレコードであるテーブルを使ったと見なして、文を実行します。つまり、SELECT文が、テーブルのようなものとして扱われているということです。
先程、あるテーブルに対するSELECTと、その結果は投下でかると書きました。つまり、結果の集合とSELECT文は小穴字と考えることができます。

リレーショナルデータベースで、集合とはテーブルのことです。そのため、SELECT文によるサブクエリと、その結果がレコードであるテーブルは、等価であるということになります。これが、SQLでサブクエリを使うことができる根拠です。

また、結果となるテーブルに名前が無いことを考えると、サブクエリは一種のラムダ式と考えることもできます。ですが、SQLは関数型言語にはなり得ません。それについては、この次に説明をします。

\section{SQLと関数型言語}

ここまでで、SELECTはフィルタであり、フィルタはもとの集合に対する関数であり、命題であるという解説をしました。そうなると、SELECTは題意球関数であるのかが気になります。結論から行くと、SELECTは題意球関数ではありません。そのため、SQLは、関数型言語ではありません。

本性の最後に、その理由を説明しましょう。

\subsection{SELECTと第一級関数・第一級オブジェクト}

第一級関数とは、引数や戻り値として、関数を扱うことができる言語です。あるSELECT文という関数への入力とはテーブルです。
このとき、テーブルの代わりにサブクエリを使うことができるので、入力に関数を取ると考えることができます。
ですが、この入力は引数ではないため、サブクエリを使っても関数を引数としたことには鳴りません。

また、SELECT文は、その出力に実行可能な形で、SELECT文という関数を返すことができません。SELECTから出てくるのは、結果の集合であり、値しか出すことができないと考えることができます。

これらの理由から、SELECTは第一級関数ではありません。
つまり、関数を含む全ての様子を無制限に取り扱える、第一級オブジェクトではありません。

\subsection{SQLは関数型言語なのか}

SELECTとは関数であり命題である、この章で繰り返し説明したテーマです。では、SQLは関数型言語なのでしょうか。
その答えは、SQLは、関数型言語の定義から外れるため、ノーとなります。

SELECTは戻り値として関数、つまりSQLの中で実行可能な形でSELECT文をはじめとするSQL文を生成することはできません。
これは、SQLが、入力と出力に制限を付けない、第一級オブジェクトではないということでもあります。
関数型言語の用件として、第一級オブジェクトを扱えること、というものがあります。そのため、SQLの構文は第一級関数ではなく、第一級オブジェクトでも無いため、SQLは関数型言語ではありません。
